from transformers import AutoModelForCausalLM, AutoTokenizer
import torch
# excute from project directory.
model_directory = "models/story"

model = AutoModelForCausalLM.from_pretrained(model_directory)

tokenizer = AutoTokenizer.from_pretrained(model_directory)
text = "Once upon a time"
inputs = tokenizer(text, return_tensors="pt")
outputs_dict = {}

def hook_fn(layer_name):
    def hook(module, input, output):
        outputs_dict[layer_name] = {
            "input": input,
            "output": output
        }
    return hook

    

# 注册钩子
for name, layer in model.named_modules():
    layer_name = f"transformer_layer_{name}"
    layer.register_forward_hook(hook_fn(layer_name))

# 执行推理
with torch.no_grad():
    model(**inputs)

x_r = torch.tensor(
    [[
[24.594484, -49.251114, -79.07112, -31.567589, -5.00046, -5.816519, 12.752559, 17.670052, 47.258507, 0.64603424, -16.602198, -24.70068, -36.483707, 23.945873, -19.580242, -45.207703, -12.644373, 2.5094566, -49.472652, -1.2442646, -64.20595, -62.37783, -151.3093, 16.493805, -15.340017, -3.7054024, -52.095787, 22.706274, 53.722195, 6.146347, 32.42618, -2.8570728, 39.59316, 6.8874073, -30.277462, 85.15386, 39.43665, -42.923977, -58.776917, 65.96003, -25.514029, 45.454758, 90.112785, 24.122416, 37.162937, -8.734257, 44.822033, 82.92949, -5.2939844, 34.61366, 4.8065014, 24.647226, 49.56593, 80.68908, 9.36648, -1.8932257, 64.34533, -15.691643, 2.1764097, 86.48459, 1.1183872, -21.852913, -31.81047, 37.257664, 19.165766, -39.449135, 48.333363, -20.330893, 54.14383, -16.947052, -95.340546, -21.020424, 40.03604, -35.03735, 12.588, -69.325424, -23.904932, 54.418877, -7.962206, 88.0314, -41.235657, -56.014328, 1.2843277, -25.983976, 91.52574, 23.574078, 16.862295, -53.22315, 616.8253, 48.367218, -114.34549, 52.952225, -41.397346, -24.965137, 14.095782, 19.061579, -39.070812, -14.183695, -7.042328, -29.251732, -50.989967, 24.194895, 100.07418, -23.437584, -34.935604, -6.1580095, 2.5536747, 22.56427, -103.00565, -8.044418, -46.49371, 113.234024, 31.300251, -28.947998, 32.603436, -2.7663574, -17.437283, 4.646473, 1.4256539, -41.355015, 11.450369, -29.137627, 48.624382, -13.109932, 15.077899, 73.961395, 13.468084, 13.5394125],
[5.6386223, -17.517574, -13.057648, 11.762318, -5.1451745, 12.098708, 10.129266, 13.166777, 16.84337, 25.019735, -15.446899, 25.456234, 1.554498, -27.144125, -24.645935, -11.865127, -12.670422, 12.772623, -12.821646, 10.351878, -44.203575, 5.1068006, -31.270382, 4.325384, -26.854431, -5.49105, -4.3105702, -2.438241, 1.5222588, -7.9857187, -1.6339345, 14.576692, -120.40451, -12.864051, -2.5643487, 11.851597, 5.6366673, -45.00733, -12.259991, 21.608852, -22.885736, -17.80659, -9.941546, 0.1552763, 1.173027, 21.710152, 28.76315, 19.476223, -27.956615, 45.50372, 21.151617, -18.332123, 6.5721254, -23.489708, -13.300556, -2.7281008, 29.307533, -10.25868, 30.424309, -10.498091, -14.520908, 23.091373, -9.871623, 5.5503645, 7.8442926, 1.041563, 12.995738, 4.24787, -13.226824, -10.623777, 3.8610628, -9.469574, 6.809539, 20.936802, -5.6016893, -3.8603945, 18.910854, 5.6392603, 37.669044, 1.533535, 10.215725, 3.02523, 47.61272, -10.681177, 1.6691799, -7.3390746, -1.5508509, -11.486555, 211.97011, -38.96655, 0.6294298, -9.184965, -24.149303, -27.17096, 32.264763, 11.529207, -21.335865, 7.3580713, 23.217562, -17.388912, -25.487839, 26.190746, 10.892609, 25.976309, -27.23872, 12.016956, -4.8169117, 3.0612388, -2.5962133, 0.4244706, 0.9325733, 18.532223, -2.933854, -41.951164, -11.581251, -2.6454735, -42.41548, -29.40213, 9.639812, -85.98949, -3.0644412, -1.4733047, 13.8880825, 5.995885, 8.584851, -11.262635, 0.12688637, -0.68478394],
[-3.8799067, 4.1166983, -13.910937, 2.6620955, 53.544518, -3.368949, -23.66205, 8.160295, -41.37121, 17.17334, -52.568157, 8.275055, -1.7301254, -43.963287, -32.21828, -7.7163234, 24.27922, 30.004602, -13.510704, 36.307, 7.6955576, -7.373077, 21.443047, -5.6985636, 23.485708, -10.570277, 14.986332, 22.941498, 4.268965, 1.1828337, 31.428055, 13.447566, -4.128975, -16.749115, -53.22489, -27.190037, 6.517315, -32.14886, 9.866241, -15.42545, -32.71105, 6.3649654, 9.518752, -10.834909, -15.288434, 28.592594, -24.036098, 25.695507, -21.572098, 14.626904, 51.023193, 24.402866, 7.590289, -13.815531, -32.402027, 24.279823, 8.752464, -33.647324, -0.15350533, -32.38477, 7.8165345, -7.8609953, -0.5654502, -33.75234, 27.827698, 11.696659, 44.84768, -23.909521, -11.088453, 38.909637, -17.763659, -11.2923565, 33.782112, -0.41315842, 18.130531, 43.3755, 19.484642, 8.212285, -26.538017, -30.284561, -10.6038, -8.757486, 25.124893, -19.163488, 0.69164085, 10.009806, -3.0192518, 2.2556462, 152.11432, -22.753271, 17.688934, -19.249714, 4.949272, 8.008598, 13.757036, 8.824238, 11.10946, -34.81264, 33.775776, -27.580482, 20.288738, 21.681482, 14.015463, 11.481049, 44.000168, 9.816311, -9.303224, -23.546299, -31.680191, -7.403407, -6.654086, 11.301204, -21.234348, -6.806488, 11.545302, 32.311367, -57.173943, -29.230062, 9.861153, -32.208363, 9.827548, -17.4403, -23.78003, 6.6399775, 13.707291, 14.159426, -19.46855, -5.332086],
[-12.418295, 1.6729951, 18.086788, -13.936039, -3.1928048, 21.49141, -7.394926, 27.831219, -1.8995571, 27.51482, 2.6934333, 22.500797, 9.072932, -21.744236, 3.451047, -2.575243, -24.527405, 1.6076273, 15.846514, -9.186329, -33.70797, 13.524414, -32.469536, -21.152374, 15.9980755, 10.368174, -2.6163013, -7.4439087, 1.7457943, 16.022806, -14.198578, -12.077244, -41.586155, -9.5887165, -12.883629, -10.677305, 32.843796, -19.870762, -8.367913, -5.2305455, 7.8235455, 37.740616, 23.281555, 32.18796, 0.6668253, -0.4879036, 8.438274, 27.941067, -16.95981, -16.816021, 36.31987, 13.290424, 0.19417095, 8.4345255, -0.25624847, 23.432135, 35.61954, -50.23535, -1.1951776, -11.7616, 15.461437, 21.439821, -32.971222, -29.059391, 10.020529, -10.40332, 32.542892, -41.455296, -37.023273, -5.2078657, -37.258877, 0.03287959, 40.294674, 23.125324, 0.31149673, -18.909397, -5.1909657, 31.766495, -21.223396, 13.302352, -8.55888, -10.192338, 46.608925, -28.613167, 11.104374, 7.445112, 19.85352, -34.48434, 215.85004, 2.5477223, -6.78689, 51.188663, -19.012476, -19.796177, 43.468594, 11.995881, 25.627028, -29.884184, 36.19745, -4.3057747, 3.1583414, 1.7933246, -5.826716, -19.198685, 36.289856, -24.882473, -11.461918, 19.517447, -28.803968, -8.515237, 5.6187882, 29.624435, 10.445269, 12.166524, 33.338997, 8.348668, -32.372528, -22.16722, 4.8226004, 41.55667, 17.697382, -12.413555, 20.14001, -33.128136, 28.98426, 20.205223, -5.754771, 4.3576174],
[33.63804, 26.206253, -23.53363, 0.24351275, -16.146862, 10.544916, -15.034065, 21.00356, -45.18855, 23.181633, -10.01992, 15.44895, -2.1682472, 7.58905, 15.587999, -21.74694, -18.149614, -48.364357, -8.609871, 61.682396, -0.9296465, -39.242577, 25.489008, -34.0592, 37.133564, 37.92684, -14.390802, 6.3394985, 16.946163, -23.041672, -10.88056, -29.59988, -21.009491, 6.3474717, -63.861248, 0.120025635, -1.0179148, -49.40351, -4.1525993, -50.893044, 24.876476, -16.525795, -40.144363, -17.075764, -38.470966, 20.124216, -28.946072, 48.47557, -23.603617, 40.06124, 0.32717276, -22.33926, -11.8672085, -3.6670978, -15.20191, -7.894356, 9.991713, 12.278412, -8.843445, -35.042686, 31.672386, 52.673412, 22.894264, 32.752827, 60.868736, 1.8057773, 8.318157, -47.07644, -14.877199, 2.1991606, -53.84468, -22.166311, -24.463717, -20.042677, 5.256974, 0.47970867, 7.7146597, 60.01809, -21.760191, -18.39165, -5.872448, 12.046202, 32.502506, -29.63094, -37.216312, 47.97938, 19.824986, -2.024067, 262.52356, -27.76895, -91.89209, 32.578842, -7.036067, 13.279735, 1.2441633, 23.970964, -11.041851, -17.481474, 59.165092, 29.823765, 25.982878, 68.11049, -52.578323, 43.993404, 90.29051, 27.004492, -44.402134, -6.0747776, -22.27509, 5.6956787, 45.463898, -47.734173, -56.54089, -13.650603, 13.775848, 59.162117, 9.151262, 0.51182556, 25.242878, -39.33296, 24.980167, -29.7515, -17.127892, -44.84376, 4.1397247, 21.5887, -38.02459, -41.24894],
[2.9755323, -8.483846, -2.2517672, 8.269536, -43.575867, -10.3251915, 8.62796, -20.766666, -0.64505386, -10.867714, -23.814466, 12.157192, 2.3833137, -13.3727865, -20.313164, -4.850276, 15.2094, 1.213959, 24.935482, 5.5091515, 25.023737, -0.23855782, -27.346312, -0.67464185, -5.1320744, 25.858921, 11.836979, 16.57462, 2.6168556, -12.736172, 4.6981726, 3.520111, -8.478226, -30.54072, 9.641487, -10.563719, -5.451688, 7.293313, -2.3473773, -13.67252, 31.692425, 10.537804, 34.45626, 3.854395, -6.2650995, 26.76907, 24.024298, 26.50633, 1.7816787, 14.059717, 25.949156, -9.833736, -21.560884, -9.801632, -4.939331, 6.767229, -2.7889025, -12.792822, 20.039446, 7.4657965, -3.8697066, 23.607346, -28.997347, -21.995453, 24.833677, 10.317312, 28.47743, -17.168615, 11.064738, 11.144897, 1.8335123, -12.409921, -10.342382, 6.632584, -10.729667, 1.8905553, 12.709099, -25.929235, 7.438493, -4.6229753, 24.887535, -16.560833, -19.800627, 19.732815, 0.16060114, 17.273556, 1.4686961, 14.081012, 34.53957, -35.816463, -2.6528995, 24.229193, 5.5122023, -26.661327, 12.825895, -1.3586159, 10.462837, 18.409376, 30.918936, -12.976852, 1.543426, -9.755338, 2.0895932, 24.861565, 27.157166, -3.2877488, 9.167156, -27.224112, -46.563107, -3.6286182, -6.32028, -40.801666, 16.201466, 1.066298, 9.924024, 14.772654, 59.43077, -32.118862, 36.816658, 15.088158, -10.958808, -40.802998, -13.860487, -30.362059, -20.716356, 10.896444, 26.663761, -26.381226],
]]
)

x = outputs_dict['transformer_layer_model.layers.1']['output'][0]

print(x - x_r > 100)